apiVersion: batch/v1
kind: Job
annotations:
  argocd.argoproj.io/sync-wave: "1"
metadata:
  name: patch-inferenceservice-config
  namespace: ic-shared-llm
spec:
  backoffLimit: 4
  template:
    spec:
      serviceAccount: modelcar-enable-sa
      serviceAccountName: modelcar-enable-sa
      containers:
      - name: patch-configmap
        image: bitnami/kubectl:latest
        command: ["/bin/sh", "-c"]
        args:
          - |
            # Wait for the operator to be in "Ready" state
            echo "Waiting for the operator to be Ready..."
            until [ "$(kubectl get dsci -n redhat-ods-applications default-dsci -o jsonpath='{.status.phase}')" = "Ready" ]; do
              echo "Operator not ready, retrying in 10s..."
              sleep 10
            done
            echo "Operator is Ready!"
            
            # Fetch current storageInitializer config
            config=$(kubectl get configmap inferenceservice-config -n redhat-ods-applications -o jsonpath='{.data.storageInitializer}');
            
            # Enable modelcars in the config
            newValue=$(echo $config | jq -c '. + {"enableModelcar": true}');
            
            # Apply the patch
            kubectl patch configmap -n redhat-ods-applications inferenceservice-config --type=json -p "[{\"op\": \"replace\", \"path\": \"/data/storageInitializer\", \"value\": \"$newValue\"}]";
            
            # Restart the KServe controller to apply changes
            kubectl delete pod -n redhat-ods-applications -l control-plane=kserve-controller-manager;
      restartPolicy: OnFailure
